<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Layout Project</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        /* Rasxot header cell blue background */
        .excel-table th.rasxot-header {
            background-color: #e2eff1 !important;
        }
        .excel-table th:nth-child(6),
        .excel-table th:nth-child(8),
        .excel-table th:nth-child(10) {
            background-color: #F5C018F7;
        }
        .excel-table td:nth-child(6),
        .excel-table td:nth-child(8),
        .excel-table td:nth-child(10) {
            background-color: #ffffff;
        }
        /* Rasxot column (7th for kirim table) */
        .excel-table th:nth-child(6),
        .excel-table td:nth-child(6) {
            background-color: #f5fdff;
        }
    </style>
</head>
<body>
    <script>
        // Global API base used by all inline scripts. Override by setting window.API_BASE before this script.
        const BASE_URL = (window.API_BASE && window.API_BASE.replace(/\/$/, '')) || 'http://localhost:5003';
    </script>
    <div class="main-btns">
        <div>
            <button id="omborBtn">Ombor</button>
        </div>
        <div>
            <button id="klentlarBtn">Klentlar</button>
        </div>
        <div>
            <button id="kirimBtn">Omborga kirim</button>
        </div>
    </div>

    <!-- Omborga kirim modal -->
    <div class="modal" id="kirimModal" style="display:none;">
    <div class="modal-content" style="width:100vw; height:100vh; margin:0; max-height:none; overflow-y:auto; background:#fff; box-shadow:none;">
            <button class="close-btn" onclick="closeModal('kirimModal')">X</button>
            <div class="table-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div class="center-title">Omborga kirim</div>
                </div>
                <table id="kirimTable" class="excel-table">
                    <thead style="background:none;">
                        <tr style="background:none;">
                            <th>№</th>
                            <th>Nomi</th>
                            <th>Miqdor (kg)</th>
                            <th>Kg narxi ($)</th>
                            <th>Jami qiymat ($)</th>
                            <th class="rasxot-header">Rasxot ($)</th>
                        </tr>
                    </thead>
                    <tbody style="background:none;">
                        <script>
        // Rasxot ($) inputiga dollar belgisi: faqat blurda ko'rsatiladi, inputda o'chadi
        document.addEventListener('DOMContentLoaded', function() {
            for (let i = 0; i < 20; i++) {
                const rasxotDollarInput = document.getElementById(`kirim-rasxot-dollar-${i}`);
                if (rasxotDollarInput) {
                    function formatDollar() {
                        let val = rasxotDollarInput.value.replace(/\$/g, '').replace(/\s/g, '');
                        if (val) {
                            rasxotDollarInput.value = val + ' $';
                        } else {
                            rasxotDollarInput.value = '';
                        }
                    }
                    rasxotDollarInput.addEventListener('input', formatDollar);
                    rasxotDollarInput.addEventListener('focus', function() {
                        rasxotDollarInput.value = rasxotDollarInput.value.replace(/\$/g, '').replace(/\s/g, '');
                    });
                    rasxotDollarInput.addEventListener('blur', formatDollar);
                }
            }

            // Omborni tozalash button for kirim modal
            var kirimClearBtn = document.createElement('button');
            kirimClearBtn.id = 'kirimClearBtn';
            kirimClearBtn.textContent = 'Omborni tozalash';
            kirimClearBtn.className = 'yangilash_btn';
            kirimClearBtn.style.marginBottom = '45px';
            var kirimTableSection = document.querySelector('#kirimModal .table-section');
            if (kirimTableSection) {
                kirimTableSection.insertBefore(kirimClearBtn, kirimTableSection.querySelector('table'));
            }
            kirimClearBtn.onclick = function() {
                for (let i = 0; i < 20; i++) {
                    let nomiInput = document.getElementById(`kirim-nomi-${i}`);
                    let miqdorInput = document.getElementById(`kirim-miqdor-${i}`);
                    let narxiInput = document.getElementById(`kirim-narxi-${i}`);
                    let jamiInput = document.getElementById(`kirim-jami-${i}`);
                    let rasxotInput = document.getElementById(`kirim-rasxot-dollar-${i}`);
                    if (nomiInput) nomiInput.value = '';
                    if (miqdorInput) miqdorInput.value = '';
                    if (narxiInput) narxiInput.value = '';
                    if (jamiInput) jamiInput.value = '';
                    if (rasxotInput) rasxotInput.value = '';
                }
                localStorage.removeItem('kirimModalData');
            };

            // Save kirim modal data to localStorage on input change
            for (let i = 0; i < 20; i++) {
                ['kirim-nomi-', 'kirim-miqdor-', 'kirim-narxi-', 'kirim-jami-', 'kirim-rasxot-dollar-'].forEach(function(prefix) {
                    let input = document.getElementById(prefix + i);
                    if (input) {
                        input.addEventListener('input', function() {
                            let data = localStorage.getItem('kirimModalData');
                            data = data ? JSON.parse(data) : {};
                            data[prefix + i] = input.value;
                            localStorage.setItem('kirimModalData', JSON.stringify(data));
                        });
                    }
                });
            }
        });
                        for (let i = 0; i < 20; i++) {
                            document.write(`
                                <tr style='background:none;'>
                                    <td>${i+1}</td>
                                    <td><input type="text" class="excel-input" id="kirim-nomi-${i}"></td>
                                    <td><input type="number" class="excel-input" id="kirim-miqdor-${i}"></td>
                                    <td><input type="text" class="excel-input" id="kirim-narxi-${i}" readonly></td>
                                    <td><input type="text" class="excel-input" id="kirim-jami-${i}"></td>
                                    <td><input type="text" class="excel-input" id="kirim-rasxot-dollar-${i}"></td>
                                </tr>
                            `);
                        }
                        </script>
                    </tbody>
                </table>
                <!-- Rasxot input -->
                <button id="kirimSaveBtn" class="yangilash_btn" style="margin-top:18px; float:right;">Saqlash</button>
            </div>
        </div>
    </div>
    </div>
    <div class="modal" id="omborModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('omborModal')">X</button>
            <div class="table-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div class="center-title">Ombor mahsulotlari</div>
                    <div style="display: flex; gap: 10px;">
                        <div style="background: lch(83.81% 15.82 226.53); padding: 10px; border-radius: 5px; font-weight: bold;">Jami miqdor: <span id="total-kg">0</span> kg</div>
                        <div style="background: lightgreen; padding: 10px; border-radius: 5px; font-weight: bold;">Jami qiymat: <span id="total-value">0.00 $ / 0 so‘m</span></div>
                            <div style="background: red ; padding: 10px; border-radius: 5px; font-weight: bold;">Foyda: <span id="total-profit">0.00 $ / 0 so‘m</span></div>
                    </div>
                </div>
                <table id="omborTable">
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>Nomi</th>
                            <th>Omborda bor mahsulotlar</th>
                            <th>Kg narxi ($)</th>
                            <th>Kg narxi (so‘m)</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <button id="omborUpdateBtn" class="yangilash_btn">Saqlash</button>
            </div>
        </div>
    </div>

        <script>
        // Omborni tozalash button logic (faqat nomi va id qoldiradi)
        document.addEventListener('DOMContentLoaded', function() {
            var omborClearBtn = document.createElement('button');
            omborClearBtn.id = 'omborClearBtn';
            omborClearBtn.textContent = 'Omborni tozalash';
            omborClearBtn.className = 'yangilash_btn';
            omborClearBtn.style.marginBottom = '45px';
            var omborTableSection = document.querySelector('#omborModal .table-section');
            if (omborTableSection) {
                omborTableSection.insertBefore(omborClearBtn, omborTableSection.querySelector('table'));
            }
            omborClearBtn.onclick = async function() {
    // Clear inputs in the frontend (except navi)
    for (let i = 0; i < 20; i++) {
        const naviInput = document.getElementById(`ombor-navi-${i}`);
        const miqdorInput = document.getElementById(`ombor-miqdor-${i}`);
        const narxiDollarInput = document.getElementById(`ombor-narxi-dollar-${i}`);
        const narxiSumInput = document.getElementById(`ombor-narxi-sum-${i}`);
        if (miqdorInput) miqdorInput.value = '';
        if (narxiDollarInput) narxiDollarInput.value = '';
        if (narxiSumInput) narxiSumInput.value = '';
    }

    // Update window.omborMahsulotlar to keep only navi and _id
    if (window.omborMahsulotlar) {
        window.omborMahsulotlar = window.omborMahsulotlar.map(item => ({
            navi: item.navi || '',
            ombordagi_mahsulot: '',
            kg_narxi: '',
            profit_dollar: 0,
            profit_sum: 0,
            _id: item._id
        }));
    }
    // Update backend to clear all fields except navi
    try {
    const res = await fetch(BASE_URL + '/ombor');
        const omborData = await res.json();
        for (const item of omborData) {
            if (item._id) {
                await fetch(`${BASE_URL}/ombor/${item._id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        navi: item.navi,
                        ombordagi_mahsulot: '',
                        kg_narxi: '',
                        profit_dollar: 0,
                        profit_sum: 0
                    })
                });
            }
        }
        await fetchOmborMahsulotlar(); // Refresh data
        renderOmborTable(); // Re-render table
        updateTotals(); // Update totals
    } catch (err) {
        console.error('Omborni tozalashda xatolik:', err);
        alert('Omborni tozalashda xatolik yuz berdi!');
    }
};
        });
        </script>

    <div class="modal" id="klentlarModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('klentlarModal')">X</button>
            <div class="center-title" style="flex:1; text-align:center;">Klentlar</div>
            <div class="modal-flex">
                <div class="table-section">
                    <div class="top-bar">
                        <div id="klentMenuIcon" class="menu-icon" style="cursor:pointer;">
                            <img src="https://cdn-icons-png.flaticon.com/512/1828/1828859.png" alt="menu" width="28" height="28"/>
                        </div>
                    </div>
                    <div id="klentlarCards" class="klentlar-cards"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="createKlentModal">
        <div class="modal-content-user_add">
            <button class="close-btn" onclick="closeModal('createKlentModal')">X</button>
            <form id="klentForm">
                <div class="center-title">Yangi klent qo‘shish</div>
                <input type="hidden" id="klentType" value="klent">
                <label>Ism:<br><input type="text" id="ism" required></label><br><br>
                <label>Telefon raqam:<br><input type="text" id="telefon" required pattern="[0-9]+" inputmode="numeric"></label><br><br>
                <button type="submit" class="open-products-btn" id="klentCreateBtn">Yaratish</button>
            </form>
        </div>
    </div>

    <div class="modal" id="klentInfoModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('klentInfoModal')">X</button>
            <div id="saveStatus" style="display:none;position:absolute;top:10px;left:50%;transform:translateX(-50%);background:#4caf50;color:#fff;padding:8px 24px;border-radius:6px;font-size:1.2em;z-index:1000;box-shadow:0 2px 8px #0002;">Saqlandi</div>
            <div id="klentInfoExcel" class="klent-info-excel"></div>
        </div>
    </div>

    <div class="modal" id="omborAddModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('omborAddModal')">X</button>
            <div class="center-title">Omborga mahsulot qo‘shish</div>
            <form id="omborForm">
                <label>Navi:<br><input type="text" id="omborNavi" required></label><br><br>
                <label>Omborda bor mahsulotlar (kg):<br><input type="number" id="omborMiqdor" required></label><br><br>
                <label>Kg narxi ($):<br><input type="text" id="omborNarxi" required></label><br><br>
                <button type="submit" class="open-products-btn">Qo‘shish</button>
            </form>
        </div>
    </div>

    <div class="side-modal" id="sideModal">
        <div class="side-modal-content">
            <button class="close-btn" onclick="closeSideModal('sideModal')">X</button>
            <div class="center-title">Klentlar menyusi</div>
            <div class="side-btns">
                <button id="sideCreateBtn" class="open-products-btn">Klentni qo'shish</button>
                <button id="sideDeleteBtn" class="open-products-btn">Klentni o'chirish</button>
            </div>
        </div>
    </div>

    <script>
        // Ombor mahsulotlarini tanlashda narxni avtomatik chiqarish (kirim modal)
        function getLastOmborNarxi(navi) {
            if (!window.omborMahsulotlar) return '';
            // Find last product with this name and return its kg_narxi
            for (let i = window.omborMahsulotlar.length - 1; i >= 0; i--) {
                const item = window.omborMahsulotlar[i];
                if (item.navi && item.navi.toLowerCase() === navi.toLowerCase()) {
                    return item.kg_narxi || '';
                }
            }
            return '';
        }

        // Kirim modal uchun narxni avtomatik to'ldirish
    for (let i = 0; i < 20; i++) {
            const nomiInput = document.getElementById(`kirim-nomi-${i}`);
            const narxiInput = document.getElementById(`kirim-narxi-${i}`);
            if (nomiInput && narxiInput) {
                nomiInput.addEventListener('blur', function() {
                    const navi = nomiInput.value.trim();
                    if (navi) {
                        // omborMahsulotlar global bo'lishi kerak
                        const narx = getLastOmborNarxi(navi);
                        if (narx) narxiInput.value = narx;
                    }
                });
            }
        }
        // Omborga kirim bo'limi uchun modal ochish
        document.getElementById('kirimBtn').onclick = function() {
            document.getElementById('kirimModal').style.display = 'flex';
            // Restore kirim modal data from localStorage
            let data = localStorage.getItem('kirimModalData');
            data = data ? JSON.parse(data) : {};
            for (let i = 0; i < 20; i++) {
                ['kirim-nomi-', 'kirim-miqdor-', 'kirim-jami-', 'kirim-rasxot-dollar-'].forEach(function(prefix) {
                    let input = document.getElementById(prefix + i);
                    if (input && typeof data[prefix + i] !== 'undefined') {
                        input.value = data[prefix + i];
                    }
                });
                // Recalculate and display Kg narxi ($)
                let miqdorInput = document.getElementById(`kirim-miqdor-${i}`);
                let jamiInput = document.getElementById(`kirim-jami-${i}`);
                let rasxotInput = document.getElementById(`kirim-rasxot-dollar-${i}`);
                let narxiInput = document.getElementById(`kirim-narxi-${i}`);
                if (miqdorInput && jamiInput && rasxotInput && narxiInput) {
                    const miqdor = parseFloat(miqdorInput.value) || 0;
                    let jamiStr = jamiInput.value.replace(/\$/g, '').replace(/\s/g, '').replace(/,/g, '.');
                    const jami = parseFloat(jamiStr) || 0;
                    let rasxotStr = rasxotInput.value.replace(/\$/g, '').replace(/\s/g, '').replace(/,/g, '.');
                    const rasxot = parseFloat(rasxotStr) || 0;
                    if (miqdor > 0) {
                        const narxi = (jami + rasxot) / miqdor;
                        let displayNarxi = narxi % 1 === 0 ? narxi : narxi.toFixed(2).replace(/\.00$/, '');
                        narxiInput.value = displayNarxi + ' $';
                    } else {
                        narxiInput.value = '';
                    }
                }
            }
        };

        // Kirim modalni yopish
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // Kirim jadvalida kg narxi hisoblash: (jami qiymat + rasxot) / miqdor
        for (let i = 0; i < 20; i++) {
            const miqdorInput = document.getElementById(`kirim-miqdor-${i}`);
            const jamiInput = document.getElementById(`kirim-jami-${i}`);
            const rasxotInput = document.getElementById(`kirim-rasxot-dollar-${i}`);
            const narxiInput = document.getElementById(`kirim-narxi-${i}`);

            const updateNarxi = function() {
                const miqdor = parseFloat(miqdorInput.value) || 0;
                let jamiStr = jamiInput.value.replace(/\$/g, '').replace(/\s/g, '').replace(/,/g, '.');
                const jami = parseFloat(jamiStr) || 0;
                let rasxotStr = rasxotInput.value.replace(/\$/g, '').replace(/\s/g, '').replace(/,/g, '.');
                const rasxot = parseFloat(rasxotStr) || 0;

                if (miqdor > 0) {
                    const narxi = (jami + rasxot) / miqdor;
                    let displayNarxi = narxi % 1 === 0 ? narxi : narxi.toFixed(2).replace(/\.00$/, '');
                    narxiInput.value = displayNarxi + ' $';
                } else {
                    narxiInput.value = '';
                }
            };

            // Jami qiymat va rasxot uchun formatlash
            [jamiInput, rasxotInput].forEach(input => {
                input.addEventListener('focus', function() {
                    input.value = input.value.replace(/\$/g, '').replace(/\s/g, '');
                });
                input.addEventListener('blur', function() {
                    let val = input.value.replace(/,/g, '.').replace(/[^\d.]/g, '');
                    if (val) {
                        let num = parseFloat(val);
                        let display = num % 1 === 0 ? num : num.toFixed(2).replace(/\.00$/, '');
                        input.value = display + ' $';
                    }
                    updateNarxi();
                });
            });

            miqdorInput.addEventListener('input', updateNarxi);
            jamiInput.addEventListener('input', updateNarxi);
            rasxotInput.addEventListener('input', updateNarxi);
        }

        // Kirimlarni saqlash
        document.getElementById('kirimSaveBtn').onclick = async function() {
            let savedCount = 0;
            const res = await fetch(BASE_URL + '/ombor');
            const all = await res.json();
            for (let i = 0; i < 20; i++) {
                const navi = document.getElementById(`kirim-nomi-${i}`).value.trim();
                const ombordagi_mahsulot = document.getElementById(`kirim-miqdor-${i}`).value;
                let narxStr = document.getElementById(`kirim-narxi-${i}`).value.replace(',', '.');
                const kg_narxi = parseFloat(narxStr.replace(/[^\d.-]/g, '')) || 0;
                if (navi && ombordagi_mahsulot && kg_narxi) {
                    try {
                        const existing = all.filter(item => item.navi && item.navi.toLowerCase() === navi.toLowerCase());
                        if (existing.length > 0) {
                            // Merge into the last one
                            const last = existing[existing.length - 1];
                            const oldMiqdor = parseFloat(last.ombordagi_mahsulot) || 0;
                            const oldNarxi = parseFloat(last.kg_narxi) || 0;
                            const newMiqdor = parseFloat(ombordagi_mahsulot) || 0;
                            const newNarxi = kg_narxi;
                            const totalMiqdor = oldMiqdor + newMiqdor;
                            const weightedNarxi = totalMiqdor > 0 ? ((oldMiqdor * oldNarxi) + (newMiqdor * newNarxi)) / totalMiqdor : 0;
                            await fetch(`${BASE_URL}/ombor/${last._id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ navi, ombordagi_mahsulot: totalMiqdor, kg_narxi: weightedNarxi })
                            });
                            // Delete duplicates if any
                            for (let j = 0; j < existing.length - 1; j++) {
                                await fetch(`${BASE_URL}/ombor/${existing[j]._id}`, { method: 'DELETE' });
                            }
                        } else {
                            await fetch(BASE_URL + '/ombor', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ navi, ombordagi_mahsulot, kg_narxi })
                            });
                        }
                        savedCount++;
                    } catch (err) {
                        alert('Xatolik: Omborga kirim saqlanmadi!');
                    }
                }
            }
            if (savedCount > 0) {
                alert(savedCount + ' ta kirim saqlandi!');
                // closeModal('kirimModal'); // Endi avtomatik yopilmaydi
                await fetchOmborMahsulotlar();
            } else {
                alert('Kiritilgan maʼlumot yoʻq!');
            }
        };
        // Modal ochish va yopish funksiyalari
        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
            if (id === 'omborAddModal') renderOmborSelect();
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            if (deleteMode) {
                deleteMode = false;
                renderKlentlarCards();
                renderYetkazuvchilarCards();
            }
        }

        document.querySelectorAll('.modal').forEach(function(modal) {
            modal.onclick = function(e) {
                if (e.target === modal) closeModal(modal.id);
            }
        });

        let klentlar = [];
        let deleteMode = false;
        let usdRate = null;
        let omborMahsulotlar = [];

        function formatDollar(value) {
            const num = parseFloat(value);
            if (isNaN(num)) return '';
            return num.toLocaleString('en-US') + ' $';
        }

        function formatSum(value) {
            const num = parseFloat(value);
            if (isNaN(num)) return '';
            return num.toLocaleString('en-US') + ' so‘m';
        }

        // Valyuta kursini olish
        async function getRates() {
            try {
                const res = await fetch("https://cbu.uz/uz/arkhiv-kursov-valyut/json/");
                const data = await res.json();
                const usd = data.find(c => c.Ccy === "USD");
                usdRate = usd ? parseFloat(usd.Rate) : null;
            } catch (err) {
                usdRate = null;
                console.error("Valyuta kursini olishda xatolik:", err);
            }
        }

        // Klentlar ro'yxatini olish
        async function fetchKlentlar() {
            try {
                const res = await fetch(BASE_URL + '/clients');
                klentlar = await res.json();
                renderKlentlarCards();
                renderYetkazuvchilarCards();
            } catch (err) {
                klentlar = [];
                console.error("Klentlarni olishda xatolik:", err);
            }
        }
        // Klent kartalarini ko‘rsatish
        function renderKlentlarCards() {
            const klentDiv = document.getElementById('klentlarCards');
            klentDiv.innerHTML = '';
            klentlar.filter(klent => klent.type === 'klent').forEach((klent) => {
                const card = document.createElement('div');
                card.className = 'klent-card';
                card.innerHTML = `
                    ${deleteMode ? `<button class=\"delete-card-btn\" title=\"O‘chirish\" style=\"position:absolute;top:6px;right:6px;font-size:18px;background:#fff;border:1px solid #f44336;color:#f44336;border-radius:50%;width:28px;height:28px;cursor:pointer;z-index:2;\" onclick=\"deleteKlent('${klent._id}', event)\">×</button>` : ''}
                    <strong>${klent.ism}</strong><br>${klent.telefon}
                `;
                card.style.position = 'relative';
                card.onclick = function(e) {
                    if (e.target.classList.contains('delete-card-btn')) return;
                    if (!deleteMode) {
                        showKlentInfo(klent);
                    }
                };
                klentDiv.appendChild(card);
            });
        }

        // Yetkazuvchilar kartalarini ko‘rsatish
        function renderYetkazuvchilarCards() {
            const yetkazuvchiDiv = document.getElementById('yetkazuvchilarCards');
            if (!yetkazuvchiDiv) return; // Agar element mavjud bo'lmasa, qaytish
            yetkazuvchiDiv.innerHTML = '';
            klentlar.filter(klent => klent.type === 'yetkazuvchi').forEach((klent) => {
                const card = document.createElement('div');
                card.className = 'klent-card';
                card.innerHTML = `
                    ${deleteMode ? `<button class=\"delete-card-btn\" title=\"O‘chirish\" style=\"position:absolute;top:6px;right:6px;font-size:18px;background:#fff;border:1px solid #f44336;color:#f44336;border-radius:50%;width:28px;height:28px;cursor:pointer;z-index:2;\" onclick=\"deleteKlent('${klent._id}', event)\">×</button>` : ''}
                    <strong>${klent.ism}</strong><br>${klent.telefon}
                `;
                card.style.position = 'relative';
                card.onclick = function(e) {
                    if (e.target.classList.contains('delete-card-btn')) return;
                    if (!deleteMode) {
                        showKlentInfo(klent);
                    }
                };
                yetkazuvchiDiv.appendChild(card);
            });
        }

        // Klentni o‘chirish
        async function deleteKlent(id, event) {
            event.stopPropagation();
            try {
                await fetch(`${BASE_URL}/clients/${id}`, { method: 'DELETE' });
                await fetchKlentlar();
            } catch (err) {
                alert("Xatolik: Klent o‘chirilmadi");
                console.error("Klent o‘chirishda xatolik:", err);
            }   
        }

        // Telefon inputlarda faqat raqam kiritish (element mavjud bo'lsa bog'lanadi)
        (function() {
            const telefonInput = document.getElementById('telefon');
            if (telefonInput) {
                telefonInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }

            // Klent qo‘shish (form mavjud bo'lsa bog'lanadi)
            const klentForm = document.getElementById('klentForm');
            if (!klentForm) return;

            klentForm.onsubmit = async function(e) {
                e.preventDefault();
                const ismEl = document.getElementById('ism');
                const telefonEl = document.getElementById('telefon');
                const createBtn = document.getElementById('klentCreateBtn');
                const ism = ismEl ? ismEl.value.trim() : '';
                const telefon = telefonEl ? telefonEl.value.trim() : '';
                const type = 'klent';

                if (!ism) {
                    alert('Iltimos ism kiriting');
                    return;
                }

                // Disable button to prevent double submits
                if (createBtn) createBtn.disabled = true;

                try {
                    // Use relative path so it works both locally and when hosted
                    const url = BASE_URL + '/clients';

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ism, telefon, type, jami_qarz_dollar: 0, jami_qarz_sum: 0 })
                    });

                    if (!response.ok) {
                        // Try to read error message if present
                        let msg = 'Klent saqlanmadi';
                        try { const errBody = await response.json(); if (errBody && (errBody.message || errBody.error)) msg = errBody.message || errBody.error; } catch(e){}
                        throw new Error(msg);
                    }

                    const newKlent = await response.json();

                    // If we already have klentlar loaded, append the new one and re-render immediately
                    if (Array.isArray(klentlar)) {
                        // Avoid duplicates: check by _id or telefon+ism
                        const exists = klentlar.some(k => (k._id && newKlent._id && k._id === newKlent._id) || (k.ism === newKlent.ism && k.telefon === newKlent.telefon));
                        if (!exists) klentlar.push(newKlent);
                    }
                    renderKlentlarCards();

                    // Close and reset only after successful save
                    closeModal('createKlentModal');
                    klentForm.reset();

                    // Show saved client info (will fetch necessary details inside)
                    showKlentInfo(newKlent);
                } catch (err) {
                    alert("Xatolik: Klent qo'shilmadi - " + (err.message || 'tarmoq xatosi'));
                    console.error("Klent qo‘shishda xatolik:", err);
                } finally {
                    if (createBtn) createBtn.disabled = false;
                }
            };
        })();

        // Klent ma'lumotlarini ko‘rsatish
        // Global API base (see top-of-file BASE_URL)

        // Helper: highlight saved row inputs (green on success, red on error)
        function highlightRow(i, ok = true) {
            try {
                const fieldsList = ["sana","mahsulot_nomi","kg","narx_sum","narx_dollar","jami_pul_sum","jami_summa_dollar","olingan_pul_sum","olingan_pul_dollar","kamomad_pul","ortiqcha_pul"];
                fieldsList.forEach(f => {
                    const el = document.getElementById(`row-${f}-${i}`);
                    if (!el) return;
                    el.style.transition = 'background-color 0.25s ease';
                    el.style.backgroundColor = ok ? '#e6ffed' : '#ffdede';
                    setTimeout(() => { el.style.backgroundColor = ''; }, 1500);
                });
            } catch (e) { console.warn('highlightRow error', e); }
        }

        // Show per-row saved indicator for ombor table
        function showOmborSaved(i, ok = true) {
            try {
                const naviEl = document.getElementById(`ombor-navi-${i}`);
                if (!naviEl) return;
                // Remove existing badge if any
                const existing = document.getElementById(`ombor-saved-${i}`);
                if (existing) existing.remove();
                const span = document.createElement('span');
                span.id = `ombor-saved-${i}`;
                span.textContent = ok ? 'Saqlandi' : 'Xatolik';
                span.style.marginLeft = '8px';
                span.style.padding = '2px 8px';
                span.style.borderRadius = '12px';
                span.style.fontSize = '12px';
                span.style.fontWeight = '700';
                span.style.color = ok ? '#0b3' : '#fff';
                span.style.background = ok ? '#e6ffe6' : '#ff4d4d';
                span.style.border = ok ? '1px solid #0a0' : '1px solid #d00';
                span.style.transition = 'opacity 0.4s ease';
                naviEl.parentNode.appendChild(span);
                // briefly flash the row background as well
                const row = naviEl.closest('tr');
                if (row) {
                    const orig = row.style.backgroundColor;
                    row.style.transition = 'background-color 0.3s ease';
                    row.style.backgroundColor = ok ? '#eaffea' : '#ffecec';
                    setTimeout(() => { row.style.backgroundColor = orig || ''; }, 1200);
                }
                // Remove badge after 2s
                setTimeout(() => { try { const el = document.getElementById(`ombor-saved-${i}`); if (el) el.remove(); } catch(e){} }, 2000);
            } catch (e) { console.warn('showOmborSaved error', e); }
        }

        async function showKlentInfo(klent) {
            try {
                await getRates();
                await fetchMahsulotlar();
                // API dan qarzlarni olish
                let qarzSum = 0;
                let qarzDollar = 0;
                try {
                    const clientRes = await fetch(`${BASE_URL}/clients/${klent._id}`);
                    if (clientRes.ok) {
                        const clientData = await clientRes.json();
                        qarzSum = clientData.jami_qarz_sum || 0;
                        qarzDollar = clientData.jami_qarz_dollar || 0;
                    }
                } catch (err) {}
                window.initialQarzSum = qarzSum;
                window.initialQarzDollar = qarzDollar;
                const klentMahsulotlar = mahsulotlar.filter(m => String(m.clientId) === String(klent._id));
                let rows = [];
                if (klentMahsulotlar.length > 0) {
                    rows = klentMahsulotlar.map(item => ({
                        ...item,
                        sana: item.sana ? item.sana.split('T')[0] : "", // Faqat sana qismini olish
                        mahsulot_nomi: item.mahsulot_nomi || "",
                        kg: item.kg || "",
                        narx_sum: item.narx_sum || "",
                        narx_dollar: item.narx_dollar || "",
                        jami_pul_sum: item.jami_pul_sum || "",
                        jami_summa_dollar: item.jami_summa_dollar || "",
                        olingan_pul_sum: item.olingan_pul_sum || "",
                        olingan_pul_dollar: item.olingan_pul_dollar || "",
                        kamomad_pul: item.kamomad_pul || "",
                        ortiqcha_pul: item.ortiqcha_pul || "",
                        original: { ...item }
                    }));
                }
                let emptyCount = 30 - rows.length;
                for (let i = 0; i < emptyCount; i++) {
                    rows.push({
                        sana: "",
                        mahsulot_nomi: "",
                        kg: "",
                        narx_sum: "",
                        narx_dollar: "",
                        jami_pul_sum: "",
                        jami_summa_dollar: "",
                        olingan_pul_sum: "",
                        olingan_pul_dollar: "",
                        kamomad_pul: "",
                        ortiqcha_pul: "",
                        _id: null,
                        original: {
                            sana: "",
                            mahsulot_nomi: "",
                            kg: "",
                            narx_sum: "",
                            narx_dollar: "",
                            jami_pul_sum: "",
                            jami_summa_dollar: "",
                            olingan_pul_sum: "",
                            olingan_pul_dollar: "",
                            kamomad_pul: "",
                            ortiqcha_pul: ""
                        }
                    });
                }
                function addMoreRowsIfNeeded() {
                    let lastFilled = -1;
                    for (let i = rows.length - 1; i >= 0; i--) {
                        let hasValue = false;
                        for (let f of ["sana","mahsulot_nomi","kg","narx_sum","narx_dollar","jami_pul_sum","jami_summa_dollar","olingan_pul_sum","olingan_pul_dollar","kamomad_pul","ortiqcha_pul"]) {
                            let el = document.getElementById(`row-${f}-${i}`);
                            if (el && el.value && el.value !== "") {
                                hasValue = true;
                                break;
                            }
                        }
                        if (hasValue) {
                            lastFilled = i;
                            break;
                        }
                    }
                    if (lastFilled >= rows.length - 1 && rows.length % 30 === 0) {
                        for (let i = 0; i < 30; i++) {
                            rows.push({
                                sana: "",
                                mahsulot_nomi: "",
                                kg: "",
                                narx_sum: "",
                                narx_dollar: "",
                                jami_pul_sum: "",
                                jami_summa_dollar: "",
                                olingan_pul_sum: "",
                                olingan_pul_dollar: "",
                                kamomad_pul: "",
                                ortiqcha_pul: "",
                                _id: null,
                                original: {
                                    sana: "",
                                    mahsulot_nomi: "",
                                    kg: "",
                                    narx_sum: "",
                                    narx_dollar: "",
                                    jami_pul_sum: "",
                                    jami_summa_dollar: "",
                                    olingan_pul_sum: "",
                                    olingan_pul_dollar: "",
                                    kamomad_pul: "",
                                    ortiqcha_pul: ""
                                }
                            });
                        }
                    }
                }

                let omborData = [];
                try {
                    const omborRes = await fetch(BASE_URL + '/ombor');
                    omborData = await omborRes.json();
                } catch (err) {
                    omborData = [];
                    alert("Ombor ma'lumotlarini olishda xatolik");
                    console.error("Ombor ma'lumotlarini olishda xatolik:", err);
                }
                const omborNomiList = omborData.map(item => ({
                    navi: item.navi || '',
                    qoldiq: item.ombordagi_mahsulot || 0,
                    _id: item._id,
                    kg_narxi: item.kg_narxi || 0
                }));

                let tableRows = rows.map((row, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td><input type="date" value="${row.sana ? row.sana.substring(0,10) : ''}" class="excel-input" id="row-sana-${i}"/></td>
                        <td>
                            <select class="excel-input" id="row-mahsulot_nomi-${i}">
                                <option value="" ${!row.mahsulot_nomi ? 'selected' : ''}></option>
                                <option value="Yolkira" ${row.mahsulot_nomi === 'Yolkira' ? 'selected' : ''}>Yolkira</option>
                                ${omborNomiList.filter(item => item.qoldiq > 0 || item.navi === row.mahsulot_nomi).map(item => `
                                    <option value="${item.navi}" ${row.mahsulot_nomi === item.navi ? 'selected' : ''}>
                                        ${item.navi}${item.qoldiq > 0 ? ` (${item.qoldiq} kg)` : ''}
                                    </option>
                                `).join('')}
                            </select>
                        </td>
                        <td><input type="number" value="${row.kg || ''}" class="excel-input" id="row-kg-${i}"/></td>
                        <td><input type="text" value="${row.narx_sum || ''}" class="excel-input" id="row-narx_sum-${i}"/></td>
                        <td><input type="text" value="${row.narx_dollar || ''}" class="excel-input" id="row-narx_dollar-${i}"/></td>
                        <td><input type="text" value="${row.jami_pul_sum || ''}" class="excel-input" id="row-jami_pul_sum-${i}"/></td>
                        <td><input type="text" value="${row.jami_summa_dollar || ''}" class="excel-input" id="row-jami_summa_dollar-${i}"/></td>
                        <td><input type="text" value="${row.olingan_pul_sum || ''}" class="excel-input" id="row-olingan_pul_sum-${i}"/></td>
                        <td><input type="text" value="${row.olingan_pul_dollar || ''}" class="excel-input" id="row-olingan_pul_dollar-${i}"/></td>
                        <td><input type="text" value="${row.kamomad_pul || ''}" class="excel-input" id="row-kamomad_pul-${i}" autocomplete="off" inputmode="decimal" pattern="[0-9.,-]*"></td>
                        <td><input type="text" value="${row.ortiqcha_pul || ''}" class="excel-input" id="row-ortiqcha_pul-${i}"/></td>
                    </tr>
                `).join('');

                let kursHtml = usdRate ? `
                    <div style="background:#fffbe6;padding:8px 0 8px 16px;font-size:1.1em;font-weight:bold;border-bottom:2px solid #e0e0e0;">
                        1$ = ${Math.round(usdRate).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ")} so‘m &nbsp;  &nbsp;
                    </div>
                    <div id="custom-jami-qarz" style="display:flex;justify-content:center;align-items:center;margin:0 0 10px 0;">
                        <div style="background:#fff9c4;color:#222;font-weight:bold;padding:2px 18px 2px 10px;font-size:1.5em;border-radius:3px 0 0 3px;min-width:120px;text-align:right;"> <span id="yolkiraQarzSum">-</span> </div>
                        <div style="background:#ffe0b2;color:#222;font-weight:bold;padding:2px 18px 2px 10px;font-size:1.5em;border-radius:0 3px 3px 0;min-width:120px;text-align:right;"> <span id="boshqaQarzDollar">$0</span> </div>
                    </div>
                ` : `
                    <div style="background:#fffbe6;padding:8px 0 8px 16px;font-size:1.1em;font-weight:bold;border-bottom:2px solid #e0e0e0;">
                        1$ = ... so‘m
                    </div>
                `;

                let updateButton = `<button id="updateBtn" class="yangilash_btn" style="margin-top:10px; float:right;">Saqlash</button>`;

                let jamiQarzSum = 0;
                let jamiQarzDollar = 0;
                let olinganQarzSum = 0;
                rows.forEach((row) => {
                    const jamiSum = parseFloat(row.jami_pul_sum) || 0;
                    const olinganSum = parseFloat(row.olingan_pul_sum) || 0;
                    const jamiDollar = parseFloat(row.jami_summa_dollar) || 0;
                    const olinganDollar = parseFloat(row.olingan_pul_dollar) || 0;
                    const kamomad = parseFloat(row.kamomad_pul) || 0;

                    if (row.mahsulot_nomi && row.mahsulot_nomi.toLowerCase() === 'oln qarz') {
                        olinganQarzSum += olinganSum;
                    } else if (!row.mahsulot_nomi || row.mahsulot_nomi === '') {
                        jamiQarzSum -= olinganSum;
                        jamiQarzSum -= kamomad;
                    } else if (row.mahsulot_nomi.toLowerCase() === 'yolkira') {
                        jamiQarzSum += jamiSum;
                        jamiQarzDollar += jamiDollar;
                        jamiQarzDollar -= olinganDollar;
                    } else {
                        jamiQarzSum += jamiSum - olinganSum;
                        jamiQarzSum += kamomad;
                        jamiQarzDollar += (jamiDollar - olinganDollar);
                    }
                });
                jamiQarzSum -= olinganQarzSum;
                // Syntax fix: remove duplicate and misplaced code

                document.getElementById('klentInfoExcel').innerHTML = `
                    ${kursHtml.replace('<span id="yolkiraQarzSum">-</span>', `<span id="yolkiraQarzSum">${(window.initialQarzSum + jamiQarzSum).toLocaleString('ru-RU')} so‘m</span>`).replace('<span id="boshqaQarzDollar">$0</span>', `<span id="boshqaQarzDollar">$${(window.initialQarzDollar + jamiQarzDollar).toLocaleString('en-US')}</span>`)}
                    <div class="excel-klent-row">
                        <span><b>${klent.ism}</b> ${klent.telefon ? klent.telefon : ''}</span>
                    </div>
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th>№</th>
                                <th>Sana</th>
                                <th>Mahsulot nomi</th>
                                <th>KG</th>
                                <th>Narx, so‘m</th>
                                <th>Narx, $</th>
                                <th>Jami pul, so‘m</th>
                                <th>Jami summa, $</th>
                                <th>Olingan pul, so‘m</th>
                                <th>Olingan pul, $</th>
                                <th>Kamomad pul</th>
                                <th>Ortiqcha pul</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    <div style="width:100%;display:flex;flex-direction:column;align-items:flex-end;gap:8px;margin-top:-30px;">
                        <button id="klentClearBtn" class="tozalash_btn" style="background:#ff6b6b;border:1px solid #cc4b4b;color:#fff;">Klentni tozalash</button>
                        ${updateButton}
                    </div>
                `;
                openModal('klentInfoModal');

                // Hisobni yangilash tugmasi va event handleri olib tashlandi

                // Format inputs after rendering
                rows.forEach((row, i) => {
                    ["narx_dollar", "jami_summa_dollar", "olingan_pul_dollar", "ortiqcha_pul"].forEach(field => {
                        const input = document.getElementById(`row-${field}-${i}`);
                        if (input && input.value) {
                            input.value = formatDollar(input.value.replace(/,/g, ''));
                        }
                    });
                    ["narx_sum", "jami_pul_sum", "olingan_pul_sum", "kamomad_pul"].forEach(field => {
                        const input = document.getElementById(`row-${field}-${i}`);
                        if (input && input.value) {
                            input.value = formatSum(input.value.replace(/,/g, ''));
                        }
                        // Olingan pul so‘m inputi o'zgarganda jami qarz hisoblash
                        if (field === "olingan_pul_sum" && input) {
                            input.addEventListener('input', function() {
                                updateJamiQarz();
                            });
                        }
                    });
                });

                const fields = [
                    "sana", "mahsulot_nomi", "kg", "narx_sum", "narx_dollar", "jami_pul_sum", "jami_summa_dollar",
                    "olingan_pul_sum", "olingan_pul_dollar", "kamomad_pul", "ortiqcha_pul"
                ];

                rows.forEach((row, i) => {
                    fields.forEach(field => {
                        const input = document.getElementById(`row-${field}-${i}`);
                        if (input) {
                            input.oninput = function() {
                                const originalVal = row.original[field] ? (field === "sana" ? row.original[field].substring(0, 10) : row.original[field].toString()) : "";
                                const newVal = input.value.replace(/ so‘m|\$/g, '').replace(/\s/g, '').replace(/,/g, '');
                                input.style.background = newVal !== originalVal ? "#b7d0ee" : "#fff";
                                hisobla(i); // Kamomadni har inputda hisoblash
                                updateJamiQarz();
                                if (i === rows.length - 1 && rows.length % 30 === 0) {
                                    addMoreRowsIfNeeded();
                                }
                            };
                            if (!input.value) input.value = "";
                            if (["narx_sum", "narx_dollar", "jami_pul_sum", "jami_summa_dollar", "olingan_pul_sum", "olingan_pul_dollar", "kamomad_pul", "ortiqcha_pul"].includes(field)) {
                                input.addEventListener('blur', function() {
                                    let val = input.value.replace(/[^\d.\-]/g, '');
                                    if (val && !isNaN(val)) {
                                        if (field.includes('dollar')) {
                                            input.value = formatDollar(val);
                                        } else if (field.includes('sum') && !field.includes('dollar')) {
                                            input.value = formatSum(val);
                                        }
                                    }
                                });
                            }
                        }
                    });
                });

                // Klentni tozalash tugmasi: UI element mavjud bo'lgach, qo'shimcha hodisa
                const klentClearBtn = document.getElementById('klentClearBtn');
                if (klentClearBtn) {
                    klentClearBtn.onclick = async function() {
                        if (!confirm('Diqqat: bu klentga tegishli barcha qatorlarni tozalashni xohlaysizmi? Bu serverdagi yozuvlarni ham 0/bo‘sh qiladi.')) return;
                        // Clear UI inputs
                        for (let i = 0; i < rows.length; i++) {
                            ['sana','mahsulot_nomi','kg','narx_sum','narx_dollar','jami_pul_sum','jami_summa_dollar','olingan_pul_sum','olingan_pul_dollar','kamomad_pul','ortiqcha_pul'].forEach(f => {
                                const el = document.getElementById(`row-${f}-${i}`);
                                if (!el) return;
                                if (f === 'mahsulot_nomi') {
                                    if (el.tagName.toLowerCase() === 'select') el.selectedIndex = 0; else el.value = '';
                                } else {
                                    el.value = '';
                                }
                            });
                        }

                        // For rows that have an _id, send PUT to clear values server-side
                        for (let i = 0; i < rows.length; i++) {
                            const id = rows[i]._id;
                            if (!id) continue;
                            const payload = {
                                mahsulot_nomi: '',
                                kg: 0,
                                narx_sum: 0,
                                narx_dollar: 0,
                                jami_pul_sum: 0,
                                jami_summa_dollar: 0,
                                olingan_pul_sum: 0,
                                olingan_pul_dollar: 0,
                                kamomad_pul: 0,
                                ortiqcha_pul: 0
                            };
                            try {
                                const res = await fetch(BASE_URL + `/users/${id}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                });
                                if (!res.ok) {
                                    console.error('Failed to clear client row', id, await res.text().catch(()=>''));
                                } else {
                                    // update local rows original if returned
                                    const saved = await res.json().catch(()=>null);
                                    if (saved) rows[i].original = { ...rows[i].original, ...saved };
                                }
                            } catch (e) { console.error('Error clearing client row', id, e); }
                        }

                        // Force recalculation of summary and UI
                        try { rows.forEach((r, idx) => { try { hisobla(idx); } catch(e){} }); } catch(e){}
                        try { updateJamiQarz(); } catch(e){}
                        alert('Klent qatorlari va serverdagi mos yozuvlar tozalandi.');
                    };
                }

                function hisobla(i) {
                    const jamiInputSum = document.getElementById(`row-jami_pul_sum-${i}`);
                    const olinganInputSum = document.getElementById(`row-olingan_pul_sum-${i}`);
                    const kamomadInput = document.getElementById(`row-kamomad_pul-${i}`);
                    const ortiqchaInput = document.getElementById(`row-ortiqcha_pul-${i}`);

                    let jamiSum = jamiInputSum?.value ? parseFloat(jamiInputSum.value.replace(/[^\d.\-]/g, '')) : 0;
                    let olinganSum = olinganInputSum?.value ? parseFloat(olinganInputSum.value.replace(/[^\d.\-]/g, '')) : 0;
                    let kamomad = kamomadInput?.value ? parseFloat(kamomadInput.value.replace(/[^\d.\-]/g, '')) : 0;
                    let ortiqcha = ortiqchaInput?.value ? parseFloat(ortiqchaInput.value.replace(/[^\d.\-]/g, '')) : 0;

                    if (isNaN(jamiSum)) jamiSum = 0;
                    if (isNaN(olinganSum)) olinganSum = 0;
                    if (isNaN(kamomad)) kamomad = 0;
                    if (isNaN(ortiqcha)) ortiqcha = 0;

                    // Do not auto-calculate kamomad or ortiqcha, keep their input values
                    kamomadInput.value = kamomad ? formatSum(kamomad) : '';
                    ortiqchaInput.value = ortiqcha ? formatSum(ortiqcha) : '';
                }

                function updateJami(i) {
                    const kgInput = document.getElementById(`row-kg-${i}`);
                    const narxDolInput = document.getElementById(`row-narx_dollar-${i}`);
                    const jamiDolInput = document.getElementById(`row-jami_summa_dollar-${i}`);
                    const jamiSumInput = document.getElementById(`row-jami_pul_sum-${i}`);

                    const kg = parseFloat(kgInput?.value) || 0;
                    const narxDol = parseFloat(narxDolInput?.value.replace(/[^\d.\-]/g, '')) || 0;
                    const jamiDol = kg * narxDol;

                    jamiDolInput.value = formatDollar(jamiDol);

                    hisobla(i);
                    updateJamiQarz();
                }

                rows.forEach((row, i) => {
                    const originalMahsulot = row.original.mahsulot_nomi || '';
                    const originalKg = parseFloat(row.original.kg) || 0;
                    const kgInput = document.getElementById(`row-kg-${i}`);
                    const narxDolInput = document.getElementById(`row-narx_dollar-${i}`);
                    const narxSumInput = document.getElementById(`row-narx_sum-${i}`);
                    const jamiDolInput = document.getElementById(`row-jami_summa_dollar-${i}`);
                    const jamiSumInput = document.getElementById(`row-jami_pul_sum-${i}`);
                    const olinganDolInput = document.getElementById(`row-olingan_pul_dollar-${i}`);
                    const olinganSumInput = document.getElementById(`row-olingan_pul_sum-${i}`);
                    const kamomadInput = document.getElementById(`row-kamomad_pul-${i}`);
                    const ortiqchaInput = document.getElementById(`row-ortiqcha_pul-${i}`);
                    const mahsulotSelect = document.getElementById(`row-mahsulot_nomi-${i}`);

                    if (mahsulotSelect) {
                        mahsulotSelect.onchange = () => {
                            const selectedNavi = mahsulotSelect.value;
                            const selectedOmbor = omborNomiList.find(item => item.navi === selectedNavi);
                            if (selectedOmbor) {
                                const narxDol = selectedOmbor.kg_narxi || 0;
                                narxDolInput.value = formatDollar(narxDol);
                                updateJami(i);
                            } else {
                                narxDolInput.value = '';
                                narxSumInput.value = '';
                                updateJami(i);
                            }
                        };
                    }

                    if (kgInput) kgInput.oninput = () => updateJami(i);

                    if (jamiDolInput) {
                        jamiDolInput.oninput = () => {
                            hisobla(i);
                            updateJamiQarz();
                        };
                    }
                    if (jamiSumInput) {
                        jamiSumInput.oninput = () => {
                            hisobla(i);
                            updateJamiQarz();
                        };
                    }
                    if (olinganDolInput) {
                        olinganDolInput.oninput = () => {
                            hisobla(i);
                            updateJamiQarz();
                        };
                    }
                    if (olinganSumInput) {
                        olinganSumInput.oninput = () => {
                            hisobla(i);
                            updateJamiQarz();
                        };
                    }
                    // Removed kamomadInput.oninput to prevent it from affecting calculations
                    if (ortiqchaInput) {
                        ortiqchaInput.oninput = () => {
                            hisobla(i);
                            updateJamiQarz();
                        };
                    }

                    const omborQoldiqMap = {};
                    omborData.forEach(item => {
                        omborQoldiqMap[item.navi] = Number(item.ombordagi_mahsulot) || 0;
                    });

                    if (mahsulotSelect && kgInput) {
                        function updateOmborQoldiq() {
                            const tanlanganMahsulot = mahsulotSelect.value;
                            const kiritilganKg = Number(kgInput.value) || 0;
                            if (!tanlanganMahsulot || kiritilganKg <= 0) return;
                            const ombordagi = omborQoldiqMap[tanlanganMahsulot] || 0;
                            let available = ombordagi;
                            if (tanlanganMahsulot === originalMahsulot) {
                                available += originalKg;
                            }
                            if (kiritilganKg > available) {
                                alert(`Omborda faqat ${available} kg "${tanlanganMahsulot}" mavjud!`);
                                kgInput.value = '';
                            }
                        }
                        mahsulotSelect.addEventListener('change', updateOmborQoldiq);
                        kgInput.addEventListener('input', updateOmborQoldiq);
                    }
                    if (row.mahsulot_nomi) {
                        mahsulotSelect.dispatchEvent(new Event('change'));
                    }
                });

                for (let i = 0; i < rows.length; i++) {
                    hisobla(i);
                }

                function updateJamiQarz() {
    let somQarz = 0;
    let dollarQarz = 0;

    document.querySelectorAll('tr').forEach((tr, i) => {
        if (i === 0) return; // Skip thead
        const mahsulotSelect = document.getElementById(`row-mahsulot_nomi-${i-1}`);
        const mahsulot = mahsulotSelect ? mahsulotSelect.value.toLowerCase() : '';
        const jamiSumInput = document.getElementById(`row-jami_pul_sum-${i-1}`);
        const olinganSumInput = document.getElementById(`row-olingan_pul_sum-${i-1}`);
        const jamiDollarInput = document.getElementById(`row-jami_summa_dollar-${i-1}`);
        const olinganDollarInput = document.getElementById(`row-olingan_pul_dollar-${i-1}`);
        const kamomadInput = document.getElementById(`row-kamomad_pul-${i-1}`);
        const ortiqchaInput = document.getElementById(`row-ortiqcha_pul-${i-1}`);

        let jamiSum = jamiSumInput?.value ? parseFloat(jamiSumInput.value.replace(/[^\d.\-]/g, '')) : 0;
        let olinganSum = olinganSumInput?.value ? parseFloat(olinganSumInput.value.replace(/[^\d.\-]/g, '')) : 0;
        let jamiDollar = jamiDollarInput?.value ? parseFloat(jamiDollarInput.value.replace(/[^\d.\-]/g, '')) : 0;
        let olinganDollar = olinganDollarInput?.value ? parseFloat(olinganDollarInput.value.replace(/[^\d.\-]/g, '')) : 0;
        let kamomad = kamomadInput?.value ? parseFloat(kamomadInput.value.replace(/[^\d.\-]/g, '')) : 0;
        let ortiqcha = ortiqchaInput?.value ? parseFloat(ortiqchaInput.value.replace(/[^\d.\-]/g, '')) : 0;

        if (isNaN(jamiSum)) jamiSum = 0;
        if (isNaN(olinganSum)) olinganSum = 0;
        if (isNaN(jamiDollar)) jamiDollar = 0;
        if (isNaN(olinganDollar)) olinganDollar = 0;
        if (isNaN(kamomad)) kamomad = 0;
        if (isNaN(ortiqcha)) ortiqcha = 0;

        if (mahsulot.includes('yolkira')) {
            somQarz += (jamiSum + kamomad - olinganSum - ortiqcha);
        } else {
            dollarQarz += (jamiDollar - olinganDollar);
            somQarz += (jamiSum + kamomad - olinganSum - ortiqcha);
        }
    });

    somQarz += window.initialQarzSum || 0;
    dollarQarz += window.initialQarzDollar || 0;

    const yolkiraQarzSumEl = document.getElementById('yolkiraQarzSum');
    if (yolkiraQarzSumEl) {
        yolkiraQarzSumEl.textContent = somQarz.toLocaleString('ru-RU') + ' so‘m';
    }
    const boshqaQarzDollarEl = document.getElementById('boshqaQarzDollar');
    if (boshqaQarzDollarEl) {
        boshqaQarzDollarEl.textContent = '$' + dollarQarz.toLocaleString('en-US');
    }
}

                document.getElementById('updateBtn').onclick = async function() {
                    let updatedCount = 0;
                    let createdCount = 0;
                    let omborUpdates = new Map();
                    // Eski qarzlarni olish (summarydan yoki backenddan)
                    let oldQarzSum = 0;
                    let oldQarzDollar = 0;
                    try {
                        const clientRes = await fetch(`${BASE_URL}/clients/${klent._id}`);
                        if (clientRes.ok) {
                            const clientData = await clientRes.json();
                            oldQarzSum = clientData.jami_qarz_sum || 0;
                            oldQarzDollar = clientData.jami_qarz_dollar || 0;
                        }
                    } catch (err) {}
                    let qarzSum = 0;
                    let qarzDollar = 0;
                    for (let i = 0; i < rows.length; i++) {
                        let rowData = {};
                        const original = rows[i].original;
                        const id = rows[i]._id;
                        let isEmpty = true;
                        fields.forEach(field => {
                            const input = document.getElementById(`row-${field}-${i}`);
                            let newVal = input ? input.value.replace(/ so‘m|\$/g, '').replace(/\s/g, '') : "";
                            if (["kg", "narx_sum", "narx_dollar", "jami_pul_sum", "jami_summa_dollar", "olingan_pul_sum", "olingan_pul_dollar", "kamomad_pul", "ortiqcha_pul"].includes(field)) {
                                newVal = newVal.replace(/,/g, '');
                            }
                            rowData[field] = field === "sana" && newVal ? new Date(newVal).toISOString() : newVal;
                            if (newVal) isEmpty = false;
                        });
                        // Faqat to'liq qatorlar (kamida mahsulot_nomi yoki yolkira, va kg yoki jami_pul_sum yoki jami_summa_dollar bo'lsa) saqlanadi
                        const mahsulotNomi = rowData.mahsulot_nomi;
                        const kgVal = rowData.kg;
                        const jamiSumVal = rowData.jami_pul_sum;
                        const jamiDollarVal = rowData.jami_summa_dollar;
                        if (isEmpty) continue;
                        const originalMahsulot = original.mahsulot_nomi || '';
                        const originalKg = parseFloat(original.kg) || 0;
                        const newMahsulot = rowData.mahsulot_nomi || originalMahsulot;
                        const newKg = parseFloat(rowData.kg) || originalKg;
                        // Qarz hisoblash (yolkira ham hisoblanadi)
                        if (
                            newKg > 0 &&
                            newMahsulot &&
                            (jamiSumVal || jamiDollarVal)
                        ) {
                            const jamiSum = parseFloat(rowData.jami_pul_sum) || 0;
                            const olinganSum = parseFloat(rowData.olingan_pul_sum) || 0;
                            const jamiDollar = parseFloat(rowData.jami_summa_dollar) || 0;
                            const olinganDollar = parseFloat(rowData.olingan_pul_dollar) || 0;
                            if (newMahsulot.toLowerCase() === 'yolkira') {
                                qarzSum += (jamiSum - olinganSum);
                            } else {
                                qarzSum += (jamiSum - olinganSum);
                                qarzDollar += (jamiDollar - olinganDollar);
                            }
                        }
                        // Ombor faqat mahsulot uchun (yolkira emas)
                        if (newKg > 0 && newMahsulot && newMahsulot.toLowerCase() !== 'yolkira') {
                            if (originalMahsulot && originalKg > 0 && originalMahsulot !== newMahsulot) {
                                const oldOmbor = omborData.find(item => item.navi === originalMahsulot);
                                if (oldOmbor) {
                                    const oldNewQoldiq = (Number(oldOmbor.ombordagi_mahsulot) || 0) + originalKg;
                                    omborUpdates.set(oldOmbor._id, {
                                        navi: oldOmbor.navi,
                                        ombordagi_mahsulot: oldNewQoldiq,
                                        kg_narxi: oldOmbor.kg_narxi
                                    });
                                }
                                const newOmbor = omborData.find(item => item.navi === newMahsulot);
                                if (newOmbor) {
                                    const newQoldiq = (Number(newOmbor.ombordagi_mahsulot) || 0) - newKg;
                                    if (newQoldiq < 0) {
                                        alert(`Xatolik: Omborda "${newMahsulot}" uchun ${newOmbor.ombordagi_mahsulot} kg mavjud, lekin ${newKg} kg kiritildi!`);
                                        return;
                                    }
                                    omborUpdates.set(newOmbor._id, {
                                        navi: newOmbor.navi,
                                        ombordagi_mahsulot: newQoldiq,
                                        kg_narxi: newOmbor.kg_narxi
                                    });
                                } else {
                                    alert(`Xatolik: "${newMahsulot}" omborda topilmadi!`);
                                    return;
                                }
                            } else {
                                const kgDifference = newKg - originalKg;
                                if (kgDifference !== 0) {
                                    const omborItem = omborData.find(item => item.navi === newMahsulot);
                                    if (omborItem) {
                                        const yangiQoldiq = (Number(omborItem.ombordagi_mahsulot) || 0) - kgDifference;
                                        if (yangiQoldiq < 0) {
                                            alert(`Xatolik: Omborda "${newMahsulot}" uchun ${omborItem.ombordagi_mahsulot} kg mavjud, lekin ${newKg} kg kiritildi!`);
                                            return;
                                        }
                                        omborUpdates.set(omborItem._id, {
                                            navi: omborItem.navi,
                                            ombordagi_mahsulot: yangiQoldiq,
                                            kg_narxi: omborItem.kg_narxi
                                        });
                                    } else {
                                        alert(`Xatolik: "${newMahsulot}" omborda topilmadi!`);
                                        return;
                                    }
                                }
                            }
                        }
                        // Har doim saqlash (yolkira ham, mahsulot ham)
                        // Ammo backend schema talablariga mos holda faqat to'liq qatorlarni yuboramiz
                        try {
                            // use global BASE_URL
                            // Required validation: mahsulot_nomi and kg (kg > 0)
                            // Note: we intentionally do NOT require 'sana' here so that
                            // other fields can be saved even when the date is empty.
                            const sanaVal = rowData.sana;
                            const mahsulotVal = (rowData.mahsulot_nomi || '').toString().trim();
                            const kgNumber = parseFloat(rowData.kg) || 0;

                            if (!mahsulotVal || kgNumber <= 0) {
                                // skip saving incomplete row to avoid backend validation errors
                                continue;
                            }

                            // normalize rowData before sending
                            // For existing records (have id) send only changed fields (partial update)

                            if (id) {
                                // build delta: compare original and current rowData
                                const delta = {};
                                const numericFields = ["kg","narx_sum","narx_dollar","jami_pul_sum","jami_summa_dollar","olingan_pul_sum","olingan_pul_dollar","kamomad_pul","ortiqcha_pul"];
                                fields.forEach(f => {
                                    let newVal = rowData[f];
                                    let origVal = original[f];
                                    // normalize values for comparison
                                    if (numericFields.includes(f)) {
                                        newVal = newVal === '' || newVal === null || newVal === undefined ? '' : String(newVal).replace(/,/g, '').replace(/\s/g, '');
                                        origVal = origVal === '' || origVal === null || origVal === undefined ? '' : String(origVal);
                                        if (newVal !== '') newVal = Number(newVal);
                                        if (origVal !== '') origVal = Number(origVal);
                                    }
                                    if (f === 'sana') {
                                        // compare dates in ISO
                                        if (newVal) newVal = new Date(newVal).toISOString();
                                        if (origVal && typeof origVal === 'string') origVal = new Date(origVal).toISOString();
                                    }
                                    if ((newVal !== '' && newVal !== null && newVal !== undefined && String(newVal) !== String(origVal)) || (newVal === '' && origVal && String(origVal) !== '')) {
                                        // Prepare value for sending
                                        if (numericFields.includes(f) && newVal !== '') {
                                            delta[f] = Number(newVal);
                                        } else if (f === 'sana') {
                                            delta[f] = newVal;
                                        } else {
                                            delta[f] = newVal;
                                        }
                                    }
                                });

                                // if nothing changed, skip
                                if (Object.keys(delta).length === 0) continue;

                                try {
                                    console.log('PUT payload for id', id, delta);
                                    const res = await fetch(BASE_URL + `/users/${id}`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(delta)
                                    });
                                    if (!res.ok) {
                                        const errBody = await res.text();
                                        console.error('PUT /users failed for id', id, res.status, errBody);
                                        highlightRow(i, false);
                                    } else {
                                        // get updated object from server and update local row + DOM
                                        const saved = await res.json();
                                        updatedCount++;
                                        // update original data for this row
                                        rows[i].original = { ...rows[i].original, ...saved };
                                        // update DOM inputs so values remain after save
                                        fields.forEach(f => {
                                            const input = document.getElementById(`row-${f}-${i}`);
                                            if (!input) return;
                                            let v = saved[f];
                                            if (f === 'sana' && v) v = v.split('T')[0];
                                            if (v === undefined || v === null) v = '';
                                            input.value = (typeof v === 'number') ? String(v) : v;
                                        });
                                        highlightRow(i, true);
                                    }
                                } catch (err) {
                                    console.error('PUT error for id', id, err);
                                    highlightRow(i, false);
                                }
                            } else {
                                // New record: merge original and rowData, require required fields
                                const merged = { ...original, ...rowData };
                                const payload = { ...merged };
                                if (payload.sana && typeof payload.sana !== 'string') payload.sana = new Date(payload.sana).toISOString();
                                ["kg","narx_sum","narx_dollar","jami_pul_sum","jami_summa_dollar","olingan_pul_sum","olingan_pul_dollar","kamomad_pul","ortiqcha_pul"].forEach(f => {
                                    if (payload[f] === undefined || payload[f] === null || payload[f] === '') return;
                                    const v = payload[f].toString().replace(/,/g, '').replace(/\s/g, '');
                                    payload[f] = isNaN(Number(v)) ? payload[f] : Number(v);
                                });
                                // validate required for new: mahsulot_nomi and kg (>0)
                                // Do not force 'sana' — allow creating records without a date
                                const sanaValMerged = payload.sana;
                                const mahsulotValMerged = (payload.mahsulot_nomi || '').toString().trim();
                                const kgNumberMerged = parseFloat(payload.kg) || 0;
                                if (!mahsulotValMerged || kgNumberMerged <= 0) {
                                    // skip saving incomplete new row
                                    continue;
                                }
                                payload.clientId = klent._id;
                                try {
                                    console.log('POST payload for new row', payload);
                                    const res = await fetch(BASE_URL + '/users', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(payload)
                                    });
                                    if (!res.ok) {
                                        const errBody = await res.text();
                                        console.error('POST /users failed', res.status, errBody);
                                        highlightRow(i, false);
                                    } else {
                                        // get created object and update local row + DOM
                                        const created = await res.json();
                                        createdCount++;
                                        // set newly created id and original
                                        rows[i]._id = created._id;
                                        rows[i].original = { ...created };
                                        // update DOM inputs to reflect saved values
                                        fields.forEach(f => {
                                            const input = document.getElementById(`row-${f}-${i}`);
                                            if (!input) return;
                                            let v = created[f];
                                            if (f === 'sana' && v) v = v.split('T')[0];
                                            if (v === undefined || v === null) v = '';
                                            input.value = (typeof v === 'number') ? String(v) : v;
                                        });
                                        highlightRow(i, true);
                                    }
                                } catch (err) {
                                    console.error('POST error', err);
                                    highlightRow(i, false);
                                }
                            }
                        } catch (err) {
                            console.error('Row save error:', err);
                        }
                    }
                    // Qarz summary ni API ga saqlash
                    // Faqat haqiqiy mahsulot (kg > 0 va narx/jami_pul_sum bor) bo'lsa qarz yangilanadi
                    let hasRealProduct = false;
                    for (let i = 0; i < rows.length; i++) {
                        const rowData = {};
                        fields.forEach(field => {
                            const input = document.getElementById(`row-${field}-${i}`);
                            let newVal = input ? input.value.replace(/ so‘m|\$/g, '').replace(/\s/g, '') : "";
                            if (["kg", "narx_sum", "narx_dollar", "jami_pul_sum", "jami_summa_dollar", "olingan_pul_sum", "olingan_pul_dollar", "kamomad_pul", "ortiqcha_pul"].includes(field)) {
                                newVal = newVal.replace(/,/g, '');
                            }
                            rowData[field] = field === "sana" && newVal ? new Date(newVal).toISOString() : newVal;
                        });
                        const newKg = parseFloat(rowData.kg) || 0;
                        const jamiSumVal = rowData.jami_pul_sum;
                        const jamiDollarVal = rowData.jami_summa_dollar;
                        if (
                            newKg > 0 &&
                            (jamiSumVal || jamiDollarVal)
                        ) {
                            hasRealProduct = true;
                            break;
                        }
                    }
                    if (hasRealProduct && (qarzSum !== 0 || qarzDollar !== 0)) {
                        await fetch(`${BASE_URL}/clients/${klent._id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ jami_qarz_sum: oldQarzSum + qarzSum, jami_qarz_dollar: oldQarzDollar + qarzDollar })
                        });
                    }
                    if (updatedCount > 0 || createdCount > 0 || omborUpdates.size > 0) {
                        let omborYangilandi = 0;
                        for (const [omborId, omborObj] of omborUpdates.entries()) {
                            await fetch(`${BASE_URL}/ombor/${omborId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(omborObj)
                            });
                            omborYangilandi++;
                        }
                        var saveStatus = document.getElementById('saveStatus');
                        if (saveStatus) {
                            saveStatus.style.display = 'block';
                            setTimeout(function() {  
                                saveStatus.style.display = 'none';
                            }, 2000);
                        }
                        await fetchKlentlar();
                        // Fetch the latest mahsulotlar from backend and update UI
                        const usersRes = await fetch(BASE_URL + '/users');
                        if (usersRes.ok) {
                            mahsulotlar = await usersRes.json();
                        }
                        showKlentInfo(klent);
                    } else {
                        var saveStatus = document.getElementById('saveStatus');
                        if (saveStatus) {
                            saveStatus.style.display = 'block';
                            setTimeout(function() {
                                saveStatus.style.display = 'none';
                            }, 2000);
                        }
                    }
                };
            } catch (err) {
                alert("Klent ma'lumotlarini ko‘rsatishda xatolik");
                console.error("Klent ma'lumotlarini ko‘rsatishda xatolik:", err);
            }
        }

        let mahsulotlar = [];

        // Mahsulotlarni olish
        async function fetchMahsulotlar() {
            try {
                const res = await fetch(BASE_URL + '/users');
                mahsulotlar = await res.json();
            } catch (err) {
                mahsulotlar = [];
                alert("Mahsulotlarni olishda xatolik");
                console.error("Mahsulotlarni olishda xatolik:", err);
            }
        }

        // Ombor mahsulotlarini olish
        async function fetchOmborMahsulotlar() {
            try {
                await getRates();
                const res = await fetch(BASE_URL + '/ombor');
                let data = await res.json();
                // Group by navi to ensure unique
                let grouped = {};
                data.forEach(item => {
                    if (item.navi) {
                        const key = item.navi.toLowerCase();
                        if (!grouped[key]) {
                            grouped[key] = {
                                navi: item.navi,
                                ombordagi_mahsulot: 0,
                                kg_narxi: 0,
                                _id: item._id,
                                count: 0,
                                totalPrice: 0,
                                // aggregate saved profits so we don't lose them when grouping
                                profit_dollar: 0,
                                profit_sum: 0
                            };
                        }
                        const miqdor = parseFloat(item.ombordagi_mahsulot) || 0;
                        const narxi = parseFloat(item.kg_narxi) || 0;
                        const pDollar = parseFloat(item.profit_dollar) || 0;
                        const pSum = parseFloat(item.profit_sum) || 0;
                        grouped[key].ombordagi_mahsulot += miqdor;
                        grouped[key].totalPrice += miqdor * narxi;
                        grouped[key].count += 1;
                        // Keep the last _id
                        grouped[key]._id = item._id;
                        // Sum profits from raw records
                        grouped[key].profit_dollar += pDollar;
                        grouped[key].profit_sum += pSum;
                    }
                });
                // Calculate weighted average
                for (let key in grouped) {
                    if (grouped[key].ombordagi_mahsulot > 0) {
                        grouped[key].kg_narxi = grouped[key].totalPrice / grouped[key].ombordagi_mahsulot;
                    } else {
                        grouped[key].kg_narxi = 0;
                    }
                    // keep profit_dollar and profit_sum aggregated
                    delete grouped[key].totalPrice;
                    delete grouped[key].count;
                }
                omborMahsulotlar = Object.values(grouped);
                renderOmborTable();
            } catch (err) {
                omborMahsulotlar = [];
                alert("Ombor mahsulotlarini olishda xatolik");
                console.error("Ombor mahsulotlarini olishda xatolik:", err);
            }
        }

        // Ombor jadvalini ko‘rsatish
        function renderOmborTable() {
            const tbody = document.querySelector("#omborTable tbody");
            tbody.innerHTML = "";
            // Kirim modalidan mahsulotlarni olish
            let kirimMahsulotlar = [];
            for (let i = 0; i < 20; i++) {
                const nomiInput = document.getElementById(`kirim-nomi-${i}`);
                if (nomiInput && nomiInput.value.trim()) {
                    kirimMahsulotlar.push(nomiInput.value.trim());
                }
            }
            // LocalStorage dan saqlangan mahsulotlarni ham tekshirish
            let storedData = localStorage.getItem('kirimModalData');
            if (storedData) {
                storedData = JSON.parse(storedData);
                for (let key in storedData) {
                    if (key.startsWith('kirim-nomi-') && storedData[key].trim()) {
                        kirimMahsulotlar.push(storedData[key].trim());
                    }
                }
            }
            // Unikal mahsulotlarni saqlash
            kirimMahsulotlar = [...new Set(kirimMahsulotlar)];

            for (let i = 0; i < 20; i++) {
                let item = (Array.isArray(omborMahsulotlar) && omborMahsulotlar[i]) ? omborMahsulotlar[i] : { navi: "", ombordagi_mahsulot: "", kg_narxi: "", _id: null };
                const totalValueDollar = (parseFloat(item.ombordagi_mahsulot) || 0) * (parseFloat(item.kg_narxi) || 0);
                const totalValueSum = usdRate ? Math.round(totalValueDollar * usdRate) : 0;
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${i + 1}</td>
                    <td>
                        <select class="excel-input" id="ombor-navi-${i}">
                            <option value=""></option>
                            ${kirimMahsulotlar.map(nomi => `<option value="${nomi}" ${item.navi === nomi ? 'selected' : ''}>${nomi}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" value="${item.ombordagi_mahsulot || ''}" class="excel-input" id="ombor-miqdor-${i}"></td>
                    <td><input type="text" value="${item.kg_narxi ? formatDollar(item.kg_narxi) : ''}" class="excel-input" id="ombor-narxi-dollar-${i}" data-original-narxi="${item.kg_narxi || 0}"></td>
                    <td><input type="text" value="${totalValueDollar ? formatSum(totalValueSum) : ''}" class="excel-input" id="ombor-narxi-sum-${i}" readonly></td>
                `;
                tbody.appendChild(tr);
            }
            // O'zgarishlarni eshitish uchun eventlar qo'shish
            for (let i = 0; i < 20; i++) {
                const miqdorInput = document.getElementById(`ombor-miqdor-${i}`);
                const narxiDollarInput = document.getElementById(`ombor-narxi-dollar-${i}`);
                const narxiSumInput = document.getElementById(`ombor-narxi-sum-${i}`);
                const naviSelect = document.getElementById(`ombor-navi-${i}`);
                if (miqdorInput) miqdorInput.addEventListener('input', updateTotals);
                if (narxiDollarInput) {
                    narxiDollarInput.addEventListener('input', updateTotals);
                    narxiDollarInput.addEventListener('focus', function() {
                        this.value = this.value.replace(/\$/g, '').replace(/\s/g, '');
                    });
                    narxiDollarInput.addEventListener('blur', function() {
                        let val = this.value.replace(/,/g, '.').replace(/[^\d.]/g, '');
                        if (val) {
                            let num = parseFloat(val);
                            let display = num % 1 === 0 ? num : num.toFixed(2).replace(/\.00$/, '');
                            this.value = display + ' $';
                        }
                        updateTotals();
                        // save the single row when price input loses focus
                        saveOmborRow(i);
                    });
                }
                // save when quantity loses focus
                if (miqdorInput) miqdorInput.addEventListener('blur', function() { saveOmborRow(i); });
                // save when product selection changes
                if (naviSelect) naviSelect.addEventListener('change', function() { saveOmborRow(i); });
            }
            updateTotals();
        }

        // Save a single ombor row to the API (PUT if exists, POST if new)
        async function saveOmborRow(i) {
            const item = omborMahsulotlar[i] || { navi: "", ombordagi_mahsulot: "", kg_narxi: 0, _id: null };
            const naviInput = document.getElementById(`ombor-navi-${i}`);
            const miqdorInput = document.getElementById(`ombor-miqdor-${i}`);
            const narxiDollarInput = document.getElementById(`ombor-narxi-dollar-${i}`);
            if (!naviInput && !miqdorInput && !narxiDollarInput) return;

            const newNavi = naviInput ? naviInput.value : (item.navi || "");
            const newMiqdor = miqdorInput ? miqdorInput.value : (item.ombordagi_mahsulot || "");
            let narxStr = narxiDollarInput ? narxiDollarInput.value : '';
            let newNarxi = 0;
            if (narxStr && narxStr.includes(',')) {
                newNarxi = parseFloat(narxStr.replace(',', '.').replace(/[^\d.-]/g, '')) || 0;
            } else {
                newNarxi = parseFloat((narxStr || '').replace(/[^\d.-]/g, '')) || 0;
            }

            function parseNumberStr(val) {
                if (val === null || typeof val === 'undefined') return 0;
                const s = String(val).replace(/\$/g, '').replace(/\s/g, '').replace(/,/g, '.');
                const cleaned = s.replace(/[^0-9.\-]/g, '');
                return parseFloat(cleaned) || 0;
            }

            const domMiqdor = parseNumberStr(newMiqdor);
            const domCurrentPrice = parseNumberStr(narxiDollarInput ? narxiDollarInput.value : newNarxi);
            const domOriginalPrice = parseNumberStr(narxiDollarInput?.dataset?.originalNarxi) || parseNumberStr(item.kg_narxi);
            const miqdorNum = domMiqdor || parseNumberStr(item.ombordagi_mahsulot) || 0;
            const profitDollar = miqdorNum * (domCurrentPrice - domOriginalPrice);
            const profitSum = usdRate ? profitDollar * usdRate : 0;
            // existing saved profit (may be aggregated from previous saves)
            const existingProfit = parseNumberStr(item.profit_dollar) || 0;
            const existingProfitSum = parseNumberStr(item.profit_sum) || 0;

            try {
                if (item._id) {
                    // update existing
                    // add delta to existing profit so it accumulates across edits
                    const cumulativeProfitDollar = existingProfit + profitDollar;
                    const cumulativeProfitSum = existingProfitSum + profitSum;
                    await fetch(`${BASE_URL}/ombor/${item._id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            navi: newNavi,
                            ombordagi_mahsulot: newMiqdor,
                            kg_narxi: newNarxi,
                            profit_dollar: Math.round((cumulativeProfitDollar + Number.EPSILON) * 100) / 100,
                            profit_sum: Math.round((cumulativeProfitSum + Number.EPSILON) * 100) / 100
                        })
                    });
                    showOmborSaved(i, true);
                } else if (newNavi || newMiqdor || newNarxi) {
                    // create new
                    await fetch(BASE_URL + '/ombor', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            navi: newNavi,
                            ombordagi_mahsulot: newMiqdor,
                            kg_narxi: newNarxi,
                            profit_dollar: Math.round((profitDollar + Number.EPSILON) * 100) / 100,
                            profit_sum: Math.round((profitSum + Number.EPSILON) * 100) / 100
                        })
                    });
                    showOmborSaved(i, true);
                }
                // Refresh local data so totals and original prices update
                await fetchOmborMahsulotlar();
            } catch (err) {
                console.error('Ombor qatorini saqlashda xatolik:', err);
                showOmborSaved(i, false);
            }
        }

        function updateTotals() {
            let totalKg = 0;
            let totalValueDollar = 0;
            let totalProfitDollar = 0;
            for (let i = 0; i < 20; i++) {
                const miqdorInput = document.getElementById(`ombor-miqdor-${i}`);
                const narxiDollarInput = document.getElementById(`ombor-narxi-dollar-${i}`);
                const narxiSumInput = document.getElementById(`ombor-narxi-sum-${i}`);
                const miqdor = parseFloat(miqdorInput?.value) || 0;
                let narxiStr = narxiDollarInput?.value.replace(/\$/g, '').replace(/\s/g, '').replace(/,/g, '.') || '0';
                const currentNarxi = parseFloat(narxiStr) || 0;
                const originalNarxi = parseFloat(narxiDollarInput?.dataset.originalNarxi) || 0;
                totalKg += miqdor;
                totalValueDollar += miqdor * currentNarxi;
                totalProfitDollar += miqdor * (currentNarxi - originalNarxi);
                // Kg narxi (so‘m) ni yangilash
                if (narxiSumInput) {
                    const totalSum = usdRate ? Math.round(miqdor * currentNarxi * usdRate) : 0;
                    narxiSumInput.value = formatSum(totalSum / miqdor) || '';
                }
            }
            // Qo'shimcha: avval saqlangan ombor yozuvlaridagi profitlarni ham qo'shamiz
            try {
                if (Array.isArray(omborMahsulotlar)) {
                    for (const saved of omborMahsulotlar) {
                        const p = parseFloat(saved?.profit_dollar) || 0;
                        totalProfitDollar += p;
                    }
                }
            } catch (e) {
                // ignore
            }
            document.getElementById('total-kg').innerText = totalKg;
            const roundedValueDollar = totalValueDollar.toLocaleString('en-US');
            const roundedValueSum = usdRate ? (totalValueDollar * usdRate).toLocaleString('en-US') : 0;
            document.getElementById('total-value').innerText = roundedValueDollar + ' $ / ' + roundedValueSum + ' so‘m';
            const roundedProfitDollar = totalProfitDollar.toLocaleString('en-US');
            const roundedProfitSum = usdRate ? (totalProfitDollar * usdRate).toLocaleString('en-US') : 0;
            document.getElementById('total-profit').innerText = roundedProfitDollar + ' $ / ' + roundedProfitSum + ' so‘m';
        }
        // Ombor yangilash
        document.getElementById('omborUpdateBtn').onclick = async function() {
            let updatedCount = 0;
            let createdCount = 0;
            for (let i = 0; i < 20; i++) {
                const item = omborMahsulotlar[i] || { navi: "", ombordagi_mahsulot: "", kg_narxi: 0, _id: null };
                const naviInput = document.getElementById(`ombor-navi-${i}`);
                const miqdorInput = document.getElementById(`ombor-miqdor-${i}`);
                const narxiDollarInput = document.getElementById(`ombor-narxi-dollar-${i}`);
                const newNavi = naviInput.value;
                const newMiqdor = miqdorInput.value;
                let narxStr = narxiDollarInput.value;
                let newNarxi = 0;
                if (narxStr.includes(',')) {
                    newNarxi = parseFloat(narxStr.replace(',', '.').replace(/[^\d.-]/g, '')) || 0;
                } else {
                    newNarxi = parseFloat(narxStr.replace(/[^\d.-]/g, '')) || 0;
                }
                // Determine changes: for numeric fields treat a difference of 1 (or more) as a meaningful change
                const origMiqdorNum = parseFloat(item.ombordagi_mahsulot) || 0;
                const newMiqdorNum = parseFloat(newMiqdor) || 0;
                const origNarxiNum = parseFloat(item.kg_narxi) || 0;
                const qtyDiff = Math.abs(newMiqdorNum - origMiqdorNum);
                const priceDiff = Math.abs(newNarxi - origNarxiNum);
                const hasChanges = (
                    newNavi !== (item.navi || "") ||
                    qtyDiff >= 1 ||         // trigger if quantity changed by at least 1 unit
                    priceDiff >= 1 ||       // trigger if kg price changed by at least 1 (dollar) unit
                    (!item._id && (newNavi || newMiqdor || newNarxi)) // new item with any value
                );
                try {
                    // Compute profit based on the actual DOM inputs (so it matches what's displayed)
                    function parseNumberStr(val) {
                        if (val === null || typeof val === 'undefined') return 0;
                        const s = String(val).replace(/\$/g, '').replace(/\s/g, '').replace(/,/g, '.');
                        const cleaned = s.replace(/[^0-9.\-]/g, '');
                        return parseFloat(cleaned) || 0;
                    }

                    // Read values from DOM to match updateTotals calculations
                    const domMiqdor = miqdorInput ? parseNumberStr(miqdorInput.value) : 0;
                    const domCurrentPrice = narxiDollarInput ? parseNumberStr(narxiDollarInput.value) : parseNumberStr(newNarxi);
                    const domOriginalPrice = parseNumberStr(narxiDollarInput?.dataset?.originalNarxi) || parseNumberStr(item.kg_narxi);

                    const miqdorNum = domMiqdor || parseNumberStr(item.ombordagi_mahsulot) || 0;
                    const profitDollar = miqdorNum * (domCurrentPrice - domOriginalPrice);
                    const profitSum = usdRate ? profitDollar * usdRate : 0;

                    if (hasChanges && item._id) {
                        await fetch(`${BASE_URL}/ombor/${item._id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                navi: newNavi,
                                ombordagi_mahsulot: newMiqdor,
                                kg_narxi: newNarxi,
                                profit_dollar: Math.round((profitDollar + Number.EPSILON) * 100) / 100,
                                profit_sum: Math.round((profitSum + Number.EPSILON) * 100) / 100
                            })
                        });
                        updatedCount++;
                        showOmborSaved(i, true);
                    } else if (hasChanges && !item._id && (newNavi || newMiqdor || newNarxi)) {
                        await fetch(BASE_URL + '/ombor', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                navi: newNavi,
                                ombordagi_mahsulot: newMiqdor,
                                kg_narxi: newNarxi,
                                profit_dollar: Math.round((profitDollar + Number.EPSILON) * 100) / 100,
                                profit_sum: Math.round((profitSum + Number.EPSILON) * 100) / 100
                            })
                        });
                        createdCount++;
                        showOmborSaved(i, true);
                    }
                } catch (err) {
                    showOmborSaved(i, false);
                    alert("Ombor ma'lumotlarini yangilashda xatolik");
                    console.error("Ombor ma'lumotlarini yangilashda xatolik:", err);
                }
            }
            if (updatedCount > 0 || createdCount > 0) {
                alert(`${updatedCount} ta yangilandi, ${createdCount} ta qo'shildi!`);
                await fetchOmborMahsulotlar();
            } else {
                alert('Oʻzgartirilgan maʼlumot yoʻq yoki ID topilmadi!');
            }
        };
        // Omborga mahsulot qo'shish
        document.getElementById('omborForm').onsubmit = async function(e) {
            e.preventDefault();
            const navi = document.getElementById('omborNavi').value;
            const ombordagi_mahsulot = document.getElementById('omborMiqdor').value;
            let narxStr = document.getElementById('omborNarxi').value.replace(',', '.');
            const kg_narxi = parseFloat(narxStr.replace(/[^\d.-]/g, '')) || 0;
            try {
                // compute profit for new item: try to find existing original price for this navi
                function parseNumberStr(val) {
                    if (val === null || typeof val === 'undefined') return 0;
                    const s = String(val).replace(/\$/g, '').replace(/\s/g, '').replace(/,/g, '.');
                    const cleaned = s.replace(/[^0-9.\-]/g, '');
                    return parseFloat(cleaned) || 0;
                }
                const q = parseNumberStr(ombordagi_mahsulot);
                const enteredPrice = parseNumberStr(kg_narxi);
                // find existing record for same navi to use as original price
                const existing = Array.isArray(omborMahsulotlar) ? omborMahsulotlar.find(x => x.navi && x.navi.toLowerCase() === (navi || '').toLowerCase()) : null;
                const origPrice = existing ? parseNumberStr(existing.kg_narxi) : 0;
                const profitDollar = q * (enteredPrice - origPrice);
                const profitSum = usdRate ? profitDollar * usdRate : 0;

                await fetch(BASE_URL + '/ombor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        navi,
                        ombordagi_mahsulot,
                        kg_narxi,
                        profit_dollar: Math.round((profitDollar + Number.EPSILON) * 100) / 100,
                        profit_sum: Math.round((profitSum + Number.EPSILON) * 100) / 100
                    })
                });
                closeModal('omborAddModal');
                document.getElementById('omborForm').reset();
                await fetchOmborMahsulotlar();
            } catch (err) {
                alert("Omborga mahsulot qo‘shishda xatolik");
                console.error("Omborga mahsulot qo‘shishda xatolik:", err);
            }
        };

        // Side modal funksiyalari
        document.getElementById('klentMenuIcon').onclick = function() {
            openSideModal('sideModal');
        };
        function openSideModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeSideModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        document.getElementById('klentlarBtn').onclick = function() {
            openModal('klentlarModal');
            deleteMode = false;
            fetchKlentlar();
        };

        document.getElementById('sideCreateBtn').onclick = function() {
            openModal('createKlentModal');
            closeSideModal('sideModal');
        };

        document.getElementById('sideDeleteBtn').onclick = function() {
            deleteMode = true;
            fetchKlentlar();
            closeSideModal('sideModal');
        };

        document.getElementById('omborBtn').onclick = function() {
            openModal('omborModal');
            fetchOmborMahsulotlar();
        };

        async function renderOmborSelect() {
            try {
                const res = await fetch(BASE_URL + '/ombor');
                const mahsulotlar = await res.json();
                const select = document.getElementById('mahsulotNomi');
                if (!select) return;
                select.innerHTML = '<option value="">Tanlang</option>';
                mahsulotlar.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.navi;
                    option.textContent = `${m.navi} (${m.ombordagi_mahsulot} kg)`;
                    select.appendChild(option);
                });
            } catch (err) {
                const select = document.getElementById('mahsulotNomi');
                if (select) select.innerHTML = '<option value="">Tanlang</option>';
                console.error("Ombor select render qilishda xatolik:", err);
            }
        }
    </script>
</body>
</html>